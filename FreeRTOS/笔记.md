# FreeRTOS学习笔记
- 学习路线是《Using the FreeRTOS Real Time Kernel》一书而来。重点记录的是原理，而不是如何使用。
- 任务管理：  
  FreeRTOS的每个任务都是一段独立的程序。每个程序都是一个死循环。而且死循环不可以用break或return之类的语句退出。任务简单的划分可以分为运行状态和非运行状态。任务有优先级，优先级数值越小表示优先级越低。调度器保证总是在所有可运行的任务中选择具有最高优先级的任务，并使其进入运行态。如果高优先级的任务一直处于运行态。低优先级的任务将得不到运行。相同优先级的任务会有一个时间片，时间片开始就进入运行态。结束进入非运行态。由于该种特性，任务是不可以一直处于运行状态的，除非该任务处于最低的优先级，否则比它低优先级的任务永远没有可能执行。所以任务需要切换到非运行态。举例来说，比如任务一是让一个LED闪烁。而任务二让另一个LED闪烁。如果2个闪烁的方式是最传统的死循环延时方式，若2个任务同等优先级，则2个LED均可以正常闪烁。而任务一的优先级高于任务二，则任务二对应的LED是没有机会闪烁的。类似的等待时间，需要让任务处于堵塞态而不是死循环死等，死等其实也是运行态，应为CPU需要不断的计数然后判断数据是否达到设定的时间，虽然这么做仅仅是为了耗时间，但CPU确实是在运行的。如果用堵塞态，调度器就会去执行低优先级的事件。若没有低优先级的事情可做。将进入空闲状态。  
  FreeRTOS是可以改变任务优先级的，修改优先级以后，调度器是会去执行更高优先级的任务。创建的任务可以删除。  
  调度算法：一：优先级抢占式调度。特点有 1.每个任务都赋予了一个优先级。2.每个任务都可以存在于一个或多个状态。3.在任何时候都只有一个任务可以处于运行状态。4.调度器总是在所有处于就绪态的任务中选择具有最高优先级的任务来执行。二：选择任务优先级，常用的一种方式是单调速率调度。根据任务周期性执行的速率来分配一个唯一的优先级。具有最高周期执行频率的任务赋予高最优先级；具有最低周期执行频率的任务赋予最低优先级。三：协作式调度。任务永远不会被抢占。  
- 队列管理：
  FreeRTOS的每个任务都是一段独立的程序。任务之间大多都会有交互。可能某个任务要在另一个任务发生之后才能开始。任务之间的通信就是通过队列实现的。我在别的地方有专门讲过这个队列。FreeRTOS的队列的特性如下：1.数据存储，这是最本质的特性，数组就是用来存东西的。2.可被多任务存取，由于队列只是一个存储的工具，当然不同的任务都可以对同一个队列操作。一般来说，一个队列被多个任务写入比较常见，被多个任务读取就不多见了。3.读/写队列时堵塞，队列有3个状态。满/空/非空非满。当队列满的时候，就不能写入；空的时候不能读取。所以FreeRTOS有一个堵塞超时机制。当队列不能操作的时候，就切换到堵塞态，给别的任务去执行。当队列可以操作的时候再来操作，当然这个等待不能时间太长。所以最长时间就是堵塞时间。  
  在创建队列时，需要制定单元个数，和每个单元对应的长度。比如建一个数组，有10个单元，每个单元存放的是字符型。那就是10个byte。而每个单元存放的都是指针，那就是40byte。系统会在堆中申请相应大小的内存，如果空间不够则会申请失败。FreeRTOS提供了专门的API函数来读/写队列。也有查询队列中有效数据个数的API。前面讲到队列的特性，可被多任务存取，那该如何区分不同数据的来源。可以使用队列传递复合数据类型，其实就是结构体。队列里存放结构体类型，结构体成员除了数据，还有说明这个数据的来源。这样就能区分不同数据的来源。  
  队列除了可以直接存放数据以外，当然也可以存放指针，这样存放的东西就非常灵活，功能更加强大。但是使用起来一定要小心。1.指针指向的空间所有权要明确，就是保证不会有任意两个任务同时修改共享内存中的数据。2.指针指向的内存要有效，因为是指针，所以实体要永远存在，实体不能存放在栈里面，释放以后队列里的指针就没有意义了。  
- 中断管理  
  延迟中断处理：使用二值信号量同步。当一个任务需要延时处理时候，任务先进入堵塞状态，等发生中断时，任务会解除堵塞，这样可以实现任务和中断的同步。所谓同步，可以理解为一起执行。进入堵塞状态，术语可以叫获取信号量，解除堵塞状态叫给出信号量。二值信号量的本质就是一个队列，只是这个队列只有一个空间。所以只存在空/满两种状态。具体实现过程为：延时处理任务调用API时，若队列为空会进入堵塞态。当进入中断会放一个信号量到队列，这时延时任务就可以获取到这个信号量，切出堵塞态，实现一个延迟中断处理功能。在中断中的API一般是给出信号量的，它有一个参数需要注意，就是当给出信号以后，获取该信号的任务优先级高于当前任务（就是被中断的任务），正常来说结束中断以后，应该回到进中断之前的函数继续执行。但是由于更高优先级的任务已经相应了，系统就必须先执行更高优先级的任务，再来执行这个被中断的任务。这时候API会修改这个参数，告知确实需要先执行更高优先级任务，需要在中断退出之前进行上下文切换。
  计数信号量：计数信号量的原理和二值信号量一样。二值信号量就是一种计数信号量的特殊形式，计数信号量具有多个数据单元。计数信号量有2种典型用法：分别是事件计数和资源管理。事件计数就是把成员存放信号量，原理和二值信号量一样。资源管理则是把成员存放可用资源数目。
